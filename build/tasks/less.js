// Generated by CoffeeScript 1.3.3

/*global module, require
*/


(function() {

  module.exports = function(grunt) {
    var fs, less, path;
    fs = require('fs');
    less = require('less');
    path = require('path');
    grunt.registerHelper('less', function(srcFiles, options, compress, callback) {
      var compileLessFile;
      compileLessFile = function(src, callback) {
        var parser;
        parser = new less.Parser({
          paths: [path.dirname(src)]
        });
        return fs.readFile(src, 'utf8', function(err, data) {
          if (err) {
            callback(err);
          }
          return parser.parse(data, function(err, tree) {
            var css;
            if (err) {
              callback(err);
            }
            css = null;
            try {
              css = tree.toCSS({
                compress: compress
              });
            } catch (e) {
              return callback(e);
            }
            return callback(null, css);
          });
        });
      };
      return grunt.utils.async.map(srcFiles, compileLessFile, function(err, results) {
        if (err) {
          return callback(err);
        }
        return callback(null, results.join(grunt.utils.linefeed));
      });
    });
    return grunt.registerMultiTask('less', 'Compile LESS to CSS', function() {
      var compress, config, dest, done, options, src, srcFiles, _ref;
      done = this.async();
      src = this.file.src;
      dest = this.file.dest;
      options = this.data.options;
      srcFiles = grunt.file.expandFiles(src);
      config = this.data;
      compress = (_ref = this.data.compress) != null ? _ref : false;
      return grunt.helper('less', srcFiles, options, compress, function(err, css) {
        if (err) {
          grunt.warn(err);
          done(false);
          return;
        }
        grunt.file.write(dest, css);
        return done();
      });
    });
  };

}).call(this);
